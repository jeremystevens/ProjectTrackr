{% extends "layout.html" %}

{% block title %}Edit Paste - FlaskBin{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h4 class="mb-0"><i class="fas fa-edit me-2"></i>Edit Paste</h4>
    </div>
    <div class="card-body paste-form">
        <form method="POST" action="{{ url_for('paste.edit', short_id=paste.short_id) }}" class="needs-validation" novalidate>
            {{ form.hidden_tag() }}
            
            <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input type="text" class="form-control" id="title" name="title" 
                       value="{{ form.title.data }}" placeholder="Paste title (optional)" maxlength="255">
            </div>
            
            <div class="mb-3">
                <label for="template" class="form-label">Template (optional)</label>
                {{ form.template(class="form-select", id="template-selector") }}
                <small id="templateHelp" class="form-text text-muted">Select a template to use as a starting point</small>
            </div>
            
            <div class="mb-3">
                <label for="content" class="form-label">Content <span class="text-danger">*</span></label>
                <textarea class="form-control" id="content-area" name="content" rows="15" required>{{ form.content.data }}</textarea>
                <div class="invalid-feedback">
                    Please enter some content for your paste.
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="syntax" class="form-label">Syntax Highlighting</label>
                    <select class="form-select" id="syntax-selector" name="syntax">
                        <option value="text" {% if form.syntax.data == 'text' %}selected{% endif %}>Plain Text</option>
                        <option value="python" {% if form.syntax.data == 'python' %}selected{% endif %}>Python</option>
                        <option value="javascript" {% if form.syntax.data == 'javascript' %}selected{% endif %}>JavaScript</option>
                        <option value="html" {% if form.syntax.data == 'html' %}selected{% endif %}>HTML</option>
                        <option value="css" {% if form.syntax.data == 'css' %}selected{% endif %}>CSS</option>
                        <option value="java" {% if form.syntax.data == 'java' %}selected{% endif %}>Java</option>
                        <option value="c" {% if form.syntax.data == 'c' %}selected{% endif %}>C</option>
                        <option value="cpp" {% if form.syntax.data == 'cpp' %}selected{% endif %}>C++</option>
                        <option value="csharp" {% if form.syntax.data == 'csharp' %}selected{% endif %}>C#</option>
                        <option value="php" {% if form.syntax.data == 'php' %}selected{% endif %}>PHP</option>
                        <option value="ruby" {% if form.syntax.data == 'ruby' %}selected{% endif %}>Ruby</option>
                        <option value="go" {% if form.syntax.data == 'go' %}selected{% endif %}>Go</option>
                        <option value="rust" {% if form.syntax.data == 'rust' %}selected{% endif %}>Rust</option>
                        <option value="swift" {% if form.syntax.data == 'swift' %}selected{% endif %}>Swift</option>
                        <option value="bash" {% if form.syntax.data == 'bash' %}selected{% endif %}>Bash/Shell</option>
                        <option value="sql" {% if form.syntax.data == 'sql' %}selected{% endif %}>SQL</option>
                        <option value="xml" {% if form.syntax.data == 'xml' %}selected{% endif %}>XML</option>
                        <option value="json" {% if form.syntax.data == 'json' %}selected{% endif %}>JSON</option>
                        <option value="markdown" {% if form.syntax.data == 'markdown' %}selected{% endif %}>Markdown</option>
                        <option value="yaml" {% if form.syntax.data == 'yaml' %}selected{% endif %}>YAML</option>
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label for="expiration" class="form-label">Expiration</label>
                    <select class="form-select" id="expiration" name="expiration">
                        <option value="0">Never</option>
                        <option value="1">10 Minutes</option>
                        <option value="2">1 Hour</option>
                        <option value="3">1 Day</option>
                        <option value="4">1 Month</option>
                    </select>
                    <small class="form-text text-muted">
                        {% if paste.expires_at %}
                            Current expiration: {{ paste.expires_at.strftime('%b %d, %Y %H:%M') }}
                        {% else %}
                            Current expiration: Never
                        {% endif %}
                    </small>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="visibility" class="form-label">Visibility</label>
                <select class="form-select" id="visibility" name="visibility">
                    <option value="public" {% if form.visibility.data == 'public' %}selected{% endif %}>Public (Visible to everyone, listed in archive)</option>
                    <option value="unlisted" {% if form.visibility.data == 'unlisted' %}selected{% endif %}>Unlisted (Visible to anyone with the link, not listed)</option>
                    <option value="private" {% if form.visibility.data == 'private' %}selected{% endif %}>Private (Only visible to you)</option>
                </select>
            </div>
            
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="comments_enabled" name="comments_enabled" 
                       {% if form.comments_enabled.data %}checked{% endif %}>
                <label class="form-check-label" for="comments_enabled">Enable comments</label>
            </div>
            
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="burn_after_read" name="burn_after_read" 
                       {% if form.burn_after_read.data %}checked{% endif %}>
                <label class="form-check-label" for="burn_after_read">Burn After Read (delete after first view)</label>
                <small class="form-text text-muted d-block">This paste will be permanently deleted after it is viewed for the first time by someone other than you.</small>
            </div>
            
            <div class="mb-3">
                <label for="edit_description" class="form-label">Edit Description</label>
                <input type="text" class="form-control" id="edit_description" name="edit_description" 
                       placeholder="Short description of your changes (optional)" maxlength="255">
                <small class="form-text text-muted">
                    This will be shown in the revision history to help understand the changes you made.
                </small>
            </div>
            
            <div id="syntax-preview" class="syntax-preview mb-3">
                <div class="text-muted">Enter some code to see syntax highlighting preview</div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Update Paste
                </button>
                <a href="{{ url_for('paste.view', short_id=paste.short_id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-2"></i>Cancel
                </a>
                {% if current_user.is_authenticated and current_user.id == paste.user_id %}
                <a href="{{ url_for('paste.revisions', short_id=paste.short_id) }}" class="btn btn-outline-secondary ms-auto">
                    <i class="fas fa-history me-2"></i>View Revision History
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Select elements
  const templateSelector = document.getElementById("template-selector");
  const contentArea = document.getElementById("content-area");
  const syntaxSelector = document.getElementById("syntax-selector");
  const helpText = document.getElementById("templateHelp");
  
  // Add event listener to template selector
  templateSelector.addEventListener("change", function() {
    const templateId = parseInt(this.value);
    
    if (templateId <= 0) {
      helpText.textContent = "Select a template to use as a starting point";
      return;
    }
    
    // In edit mode, always confirm before replacing content
    if (confirm("Replace your current content with this template? Your existing content will be lost.")) {
      // Load template data via AJAX
      fetch("/template/" + templateId)
        .then(response => response.json())
        .then(data => {
          // Update help text
          helpText.innerHTML = "<i class=\"fas fa-info-circle me-1\"></i> " + data.description;
          
          contentArea.value = data.content;
          syntaxSelector.value = data.syntax;
          updateSyntaxPreview();
        })
        .catch(error => {
          console.error("Error loading template:", error);
          helpText.innerHTML = "<span class=\"text-danger\">Error loading template</span>";
        });
    }
  });
  
  // Syntax preview functionality
  function updateSyntaxPreview() {
    const content = contentArea.value;
    const syntax = syntaxSelector.value;
    const previewContainer = document.getElementById("syntax-preview");
    
    if (!content || content.trim() === "") {
      previewContainer.innerHTML = '<div class="text-muted">Enter some code to see syntax highlighting preview</div>';
      return;
    }
    
    // Show loading indicator
    previewContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    // Make the fetch request
    fetch("/api/highlight", {
      method: "POST",
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken
      },
      body: new URLSearchParams({
        'content': content.substring(0, 500),  // Limit to 500 chars for preview
        'syntax': syntax
      })
    })
    .then(response => {
      console.log("Response status:", response.status);
      return response.json();
    })
    .then(data => {
      console.log("Got highlight data:", data);
      
      // Add the highlighted HTML and CSS
      if (data.css && !document.getElementById('pygments-css')) {
        const style = document.createElement('style');
        style.id = 'pygments-css';
        style.textContent = data.css;
        document.head.appendChild(style);
      }
      
      previewContainer.innerHTML = '<div class="preview-code">' + data.highlighted + '</div>';
      
      if (content.length > 500) {
        const ellipsis = document.createElement('div');
        ellipsis.className = 'text-muted';
        ellipsis.textContent = '... (preview truncated)';
        previewContainer.appendChild(ellipsis);
      }
    })
    .catch(error => {
      console.error("Error getting syntax preview:", error);
      previewContainer.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error generating preview.</div>';
    });
  }
  
  // Set up syntax preview events
  contentArea.addEventListener("input", debounce(updateSyntaxPreview, 500));
  syntaxSelector.addEventListener("change", updateSyntaxPreview);
  
  // Debounce function to prevent too many requests
  function debounce(func, wait) {
    let timeout;
    return function() {
      const context = this;
      const args = arguments;
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        func.apply(context, args);
      }, wait);
    };
  }
  
  // Initial syntax preview update
  setTimeout(updateSyntaxPreview, 1000);
});
</script>
{% endblock %}
