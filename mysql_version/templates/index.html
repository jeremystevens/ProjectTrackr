{% extends "layout.html" %}

{% block title %}Create New Paste | FlaskBin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h2>Create New Paste</h2>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('index') }}">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title (Optional)</label>
                        <input type="text" class="form-control" id="title" name="title" placeholder="Untitled Paste">
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">Content</label>
                        <textarea class="form-control" id="content" name="content" rows="12" required></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="language" class="form-label">Syntax Highlighting</label>
                            <select class="form-select" id="language" name="language">
                                <option value="plaintext">Plain Text</option>
                                <option value="python">Python</option>
                                <option value="javascript">JavaScript</option>
                                <option value="html">HTML</option>
                                <option value="css">CSS</option>
                                <option value="java">Java</option>
                                <option value="csharp">C#</option>
                                <option value="cpp">C++</option>
                                <option value="php">PHP</option>
                                <option value="ruby">Ruby</option>
                                <option value="go">Go</option>
                                <option value="rust">Rust</option>
                                <option value="swift">Swift</option>
                                <option value="kotlin">Kotlin</option>
                                <option value="sql">SQL</option>
                                <option value="bash">Bash</option>
                                <option value="json">JSON</option>
                                <option value="xml">XML</option>
                                <option value="yaml">YAML</option>
                                <option value="markdown">Markdown</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="expiration" class="form-label">Expiration</label>
                            <select class="form-select" id="expiration" name="expiration">
                                <option value="never">Never</option>
                                <option value="10min">10 Minutes</option>
                                <option value="1h">1 Hour</option>
                                <option value="1d">1 Day</option>
                                <option value="1w">1 Week</option>
                                <option value="1m">1 Month</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="visibility" class="form-label">Visibility</label>
                            <select class="form-select" id="visibility" name="visibility">
                                <option value="public">Public</option>
                                <option value="unlisted">Unlisted</option>
                                {% if is_authenticated() %}
                                <option value="private">Private</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="comments_enabled" name="comments_enabled" checked>
                                <label class="form-check-label" for="comments_enabled">
                                    Enable comments
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="burn_after_read" name="burn_after_read">
                                <label class="form-check-label" for="burn_after_read">
                                    Burn after reading
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="encrypt_paste" name="encrypt_paste">
                            <label class="form-check-label" for="encrypt_paste">
                                Encrypt this paste
                            </label>
                        </div>
                        <div class="mt-2 encryption-options" style="display: none;">
                            <label for="encryption_password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="encryption_password" name="encryption_password">
                            <div class="form-text">
                                Warning: If you lose this password, you won't be able to decrypt your paste!
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Paste</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h3>Recent Pastes</h3>
            </div>
            <div class="card-body">
                {% if recent_pastes %}
                <ul class="list-group">
                    {% for paste in recent_pastes %}
                    <li class="list-group-item">
                        <a href="{{ url_for('view_paste', short_id=paste.short_id) }}">
                            {{ paste.title or 'Untitled Paste' }}
                        </a>
                        <div class="metadata">
                            <small class="text-muted">{{ paste.created_at|timesince }}</small>
                            {% if paste.language != 'plaintext' %}
                            <span class="badge bg-secondary">{{ paste.language }}</span>
                            {% endif %}
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No recent pastes available.</p>
                {% endif %}
            </div>
        </div>
        
        {% if is_authenticated() and user_pastes %}
        <div class="card">
            <div class="card-header">
                <h3>Your Pastes</h3>
            </div>
            <div class="card-body">
                <ul class="list-group">
                    {% for paste in user_pastes %}
                    <li class="list-group-item">
                        <a href="{{ url_for('view_paste', short_id=paste.short_id) }}">
                            {{ paste.title or 'Untitled Paste' }}
                        </a>
                        <div class="metadata">
                            <small class="text-muted">{{ paste.created_at|timesince }}</small>
                            {% if paste.language != 'plaintext' %}
                            <span class="badge bg-secondary">{{ paste.language }}</span>
                            {% endif %}
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle encryption option toggle
        const encryptCheckbox = document.getElementById('encrypt_paste');
        const encryptionOptions = document.querySelector('.encryption-options');
        
        encryptCheckbox.addEventListener('change', function() {
            encryptionOptions.style.display = this.checked ? 'block' : 'none';
            
            // If encryption is enabled, default to 'unlisted' visibility
            if (this.checked) {
                document.getElementById('visibility').value = 'unlisted';
            }
        });
        
        // Handle burn after read and expiration interaction
        const burnCheckbox = document.getElementById('burn_after_read');
        const expirationSelect = document.getElementById('expiration');
        
        burnCheckbox.addEventListener('change', function() {
            if (this.checked) {
                // Save the current expiration selection
                expirationSelect.dataset.previousValue = expirationSelect.value;
                // Set expiration to 'never' when burn after read is enabled
                expirationSelect.value = 'never';
                expirationSelect.disabled = true;
            } else {
                // Restore previous selection if available
                if (expirationSelect.dataset.previousValue) {
                    expirationSelect.value = expirationSelect.dataset.previousValue;
                }
                expirationSelect.disabled = false;
            }
        });
        
        // Auto-detect language based on content
        const contentArea = document.getElementById('content');
        const languageSelect = document.getElementById('language');
        
        contentArea.addEventListener('blur', function() {
            // Only try to detect if user hasn't explicitly selected a language
            if (languageSelect.dataset.userSelected) return;
            
            const content = this.value.trim();
            if (content.length < 10) return; // Need some content to detect
            
            // Very simple detection for demonstration
            if (content.includes('def ') && content.includes('import ')) {
                languageSelect.value = 'python';
            } else if (content.includes('function') && (content.includes('var ') || content.includes('const '))) {
                languageSelect.value = 'javascript';
            } else if (content.includes('<html') || content.includes('<!DOCTYPE')) {
                languageSelect.value = 'html';
            } else if (content.includes('class') && content.includes('{') && content.includes('}')) {
                if (content.includes('public static void main')) {
                    languageSelect.value = 'java';
                } else if (content.includes('namespace')) {
                    languageSelect.value = 'csharp';
                }
            } else if (content.includes('SELECT') && content.includes('FROM')) {
                languageSelect.value = 'sql';
            }
        });
        
        // Mark language as user-selected
        languageSelect.addEventListener('change', function() {
            this.dataset.userSelected = 'true';
        });
    });
</script>
{% endblock %}